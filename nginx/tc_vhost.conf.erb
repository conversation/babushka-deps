upstream <%= upstream_name %> {
  # fail_timeout=0 means we always retry the unicorn master, since it's
  # responsible for restarting workers when they fail.
  server unix:<%= unicorn_socket %> fail_timeout=0;
}

server {
  listen <%= listen_host %>:<%= listen_port %>;

  # Redirect to the canonical domain.
  if ($host !~ ^<%= domain.to_s.gsub('.', '\.') %>$) {
    rewrite ^(.*)$ http://<%= domain %>$1 permanent;
  }

  include vhosts/<%= domain %>.common;
}

server {
  listen <%= listen_host %>:443 ssl;

  ssl_certificate      certs/<%= domain %>.crt;
  ssl_certificate_key  certs/<%= domain %>.key;
  ssl_session_timeout  5m;
  ssl_ciphers          HIGH:!aNULL:!MD5:!kEDH;

  # Redirect to the canonical domain.
  if ($host !~ ^<%= domain.to_s.gsub('.', '\.') %>$) {
    rewrite ^(.*)$ https://<%= domain %>$1 permanent;
  }

  include vhosts/<%= domain %>.common;
}
