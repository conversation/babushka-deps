description "<%=user%> unicorns"

start on (filesystem and static-network-up)
stop on runlevel [!2345]

respawn

kill signal QUIT

chdir <%=app_root%>
setuid <%=user%>
console log

script
  /usr/local/bin/bundle exec unicorn -c config/unicorn.rb -E <%=env%>

  exists=0
  pidfile=<%=app_root%>/tmp/pids/unicorn.pid
  oldpidfile=<%=app_root%>/tmp/pids/unicorn.pid.oldbin

  while [ $exists -eq 0 ]
  do
    sleep 1

    (test -f $pidfile && pgrep -P $(cat $pidfile)) || (test -f $oldpidfile && pgrep -P $(cat $oldpidfile))
    exists=$?
  done

  exec rm <%=app_root%>/tmp/pids/unicorn.pid
  exec rm <%=app_root%>/tmp/pids/unicorn.pid.oldbin

  exit 1
end script
