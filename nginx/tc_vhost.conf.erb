upstream <%= upstream_name %> {
  # fail_timeout=0 means we always retry the unicorn master, since it's
  # responsible for restarting workers when they fail.
  server unix:<%= unicorn_socket %> fail_timeout=0;
}

server {
  listen <%= listen_host %>:<%= listen_port %>;
  server_name www.<%= domain %>;
  return 301 http://<%= domain %>$request_uri;
}

<% if env == 'production' %>
server {
  listen <%= listen_host_dot_com %>:<%= listen_port %>;
  server_name www.<%= domain_dot_com %>;
  return 301 http://<%= domain_dot_com %>$request_uri;
}

server {
  listen <%= listen_host_uk %>:<%= listen_port %>;
  server_name www.<%= domain_uk %>;
  return 301 http://<%= domain_uk %>$request_uri;
}
<% end %>

server {
  listen <%= listen_host %>:<%= listen_port %>;
  listen <%= listen_host %>:443 ssl;
  server_name <%= domain %>;

  ssl_certificate      certs/<%= domain %>.crt;
  ssl_certificate_key  certs/<%= domain %>.key;
  ssl_session_timeout  5m;
  ssl_ciphers          HIGH:!aNULL:!MD5:!kEDH;

  <% if env == 'production' %>
  # All traffic is redirected to .com
  location = / {
    return 301 $scheme://<%= domain_dot_com %>/au;
  }
  location / {
    return 301 $scheme://<%= domain_dot_com %>$request_uri;
  }
  <% end %>
}

<% if env == 'production' %>
server {
  listen <%= listen_host_dot_com %>:<%= listen_port %>;
  server_name <%= domain_dot_com %>;

  # Redirect authed users to https. (The app does this too; we redirect
  # cached pages here to avoid having to do it on the frontend.)
  if ($http_cookie ~ 'user_tracer_engage') {
    rewrite ^(.*)$ https://$host$1 redirect;
  }

  include vhosts/<%= domain %>.common;
}

server {
  listen <%= listen_host_dot_com %>:443 ssl;
  server_name <%= domain_dot_com %>;

  ssl_certificate      certs/<%= domain_dot_com %>.crt;
  ssl_certificate_key  certs/<%= domain_dot_com %>.key;
  ssl_session_timeout  5m;
  ssl_ciphers          HIGH:!aNULL:!MD5:!kEDH;

  include vhosts/<%= domain %>.common;
}

server {
  listen <%= listen_host_uk %>:<%= listen_port %>;
  server_name <%= domain_uk %>;

  location = / {
    return 301 $scheme://<%= domain_dot_com %>/uk;
  }
  location / {
    return 301 $scheme://<%= domain_dot_com %>$request_uri;
  }
}
<% end %>
