upstream <%= upstream_name %> {
  # fail_timeout=0 means we always retry the unicorn master, since it's
  # responsible for restarting workers when they fail.
  server unix:<%= application_socket %> fail_timeout=0;
}

# Canonical www. redirect
server {
  listen <%= listen_port %>;
  server_name www.counter.theconversation.edu.au www.counter.theconversation.com;
  return 301 http://counter.theconversation.com$request_uri;
}

server {
  server_name counter.theconversation.edu.au;

  listen <%= listen_port %>;

  listen 443 ssl;

  ssl_certificate      /etc/ssl/certs/counter.theconversation.edu.au.crt;
  ssl_certificate_key  /etc/ssl/private/counter.theconversation.edu.au.key;
  ssl_session_timeout  5m;
  ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers          ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA:HIGH:!aNULL:!MD5:!kEDH;
  ssl_prefer_server_ciphers on;

  include /etc/nginx/sites-available/<%= domain %>.common;
}

server {
  server_name counter.theconversation.com;

  listen <%= listen_port %>;

  listen 443 ssl;

  ssl_certificate      /etc/ssl/certs/counter.theconversation.com.crt;
  ssl_certificate_key  /etc/ssl/private/counter.theconversation.com.key;
  ssl_session_timeout  5m;
  ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers          ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA:HIGH:!aNULL:!MD5:!kEDH;
  ssl_prefer_server_ciphers on;

  include /etc/nginx/sites-available/<%= domain %>.common;
}
