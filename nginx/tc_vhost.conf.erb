upstream <%= upstream_name %> {
  # fail_timeout=0 means we always retry the unicorn master, since it's
  # responsible for restarting workers when they fail.
  server unix:<%= unicorn_socket %> fail_timeout=0;
}

server {
  listen <%= listen_host %>:<%= listen_port %>;
  server_name <%= server_names.join(' ') %>;

  # Redirect authed users to https. (The app does this too; we redirect
  # cached pages here to avoid having to do it on the frontend.)
  if ($http_cookie ~ 'user_tracer_engage') {
    rewrite ^(.*)$ https://$host$1 redirect;
  }

  include vhosts/<%= domain %>.common;
}

server {
  listen <%= listen_host %>:443 ssl;
  server_name <%= server_names.join(' ') %>;

  ssl_certificate      certs/<%= domain %>.crt;
  ssl_certificate_key  certs/<%= domain %>.key;
  ssl_session_timeout  5m;
  ssl_ciphers          HIGH:!aNULL:!MD5:!kEDH;

  include vhosts/<%= domain %>.common;
}

<% if env == 'production' %>
server {
  listen <%= listen_host_dot_com %>:443 ssl;
  server_name <%= domain_dot_com %>;

  ssl_certificate      certs/<%= domain_dot_com %>.crt;
  ssl_certificate_key  certs/<%= domain_dot_com %>.key;
  ssl_session_timeout  5m;
  ssl_ciphers          HIGH:!aNULL:!MD5:!kEDH;

  include vhosts/<%= domain %>.common;
}
<% end %>
